"use strict";class t{constructor(){this.events={}}on(t,e){this.events[t]||(this.events[t]=[]),this.events[t].push(e)}emit(t,e){this.events[t]&&this.events[t].forEach((t=>t(e)))}}class e{constructor(t,e={}){this.text=t,this.attributes={bold:e.bold||!1,italic:e.italic||!1,underline:e.underline||!1}}isBold(){return this.attributes.bold}setBold(t){this.attributes.bold=t}isItalic(){return this.attributes.italic}setItalic(t){this.attributes.italic=t}isUnderline(){return this.attributes.underline}setUnderline(t){this.attributes.underline=t}clone(){return new e(this.text,Object.assign({},this.attributes))}hasSameAttributes(t){return this.attributes.bold===t.attributes.bold&&this.attributes.italic===t.attributes.italic&&this.attributes.underline===t.attributes.underline}}class s extends t{get selectedBlockId(){return this._selectedBlockId}set selectedBlockId(t){if(this._selectedBlockId!==t){this._selectedBlockId=t;const e=this.getCursorOffset(document.querySelector('[id="editor"]')),s=this.getCursorOffset(document.querySelector('[data-id="'+t+'"]'));this.currentOffset=e-s}}constructor(){super(),this._selectedBlockId=null,this.pieces=[new e("")],this.blocks=[{dataId:"data-id-1734604240404",class:"paragraph-block",pieces:[new e(" ")]}],this.selectedBlockId="data-id-1734604240404",this.currentOffset=0}getPlainText(){return this.pieces.map((t=>t.text)).join("")}insertAt(t,s,i,n="",o=0){let l=0,c=[],r=!1,d=0;""===n&&null===n||(d=this.blocks.findIndex((t=>t.dataId===n)),l=this.currentOffset);for(let n of this.blocks[d].pieces){const o=l+n.text.length;if(!r&&i<=o){const o=i-l;o>0&&c.push(new e(n.text.slice(0,o),Object.assign({},n.attributes))),c.push(new e(t,{bold:s.bold||!1,italic:s.italic||!1,underline:s.underline||!1})),o<n.text.length&&c.push(new e(n.text.slice(o),Object.assign({},n.attributes))),r=!0}else c.push(n.clone());l=o}if(!r){const i=c[c.length-1];i&&i.hasSameAttributes(new e("",{bold:s.bold||!1,italic:s.italic||!1,underline:s.underline||!1}))?i.text+=t:c.push(new e(t,{bold:s.bold||!1,italic:s.italic||!1,underline:s.underline||!1}))}const a=this.mergePieces(c);this.blocks[d].pieces=a,this.emit("documentChanged",this)}deleteRange(t,s,i="",n=0){if(t===s)return;let o=[],l=0,c=0;""===i&&null===i||(c=this.blocks.findIndex((t=>t.dataId===i)),l=n);for(let i of this.blocks[c].pieces){const n=l+i.text.length;if(n<=t||l>=s)o.push(i.clone());else{const c=l,r=i.text;t>c&&t<n&&o.push(new e(r.slice(0,t-c),Object.assign({},i.attributes))),s<n&&o.push(new e(r.slice(s-c),Object.assign({},i.attributes)))}l=n}const r=this.mergePieces(o);this.blocks[c].pieces=r,0===r.length&&this.blocks.length>1&&(this.blocks=this.blocks.filter((t=>0!==t.pieces.length))),this.emit("documentChanged",this)}getCursorOffset(t){const e=window.getSelection();if(!e||0===e.rangeCount)return-1;const s=e.getRangeAt(0);let i=0;const n=t=>{var e;return t===s.startContainer?(i+=s.startOffset,!0):(3===t.nodeType&&(i+=(null===(e=t.textContent)||void 0===e?void 0:e.length)||0),Array.from(t.childNodes).some(n))};return n(t),i}formatAttribute(t,s,i,n){let o=[],l=0,c=-1;""===this.selectedBlockId&&null===this.selectedBlockId||(c=this.blocks.findIndex((t=>t.dataId===this.selectedBlockId)),l=this.currentOffset);for(let r of this.blocks[c].pieces){const c=l+r.text.length;if(c<=t||l>=s)o.push(r.clone());else{const c=l,d=r.text,a=Math.max(t-c,0),u=Math.min(s-c,d.length);a>0&&o.push(new e(d.slice(0,a),Object.assign({},r.attributes)));const h=new e(d.slice(a,u),Object.assign({},r.attributes));h.attributes[i]=n,o.push(h),u<d.length&&o.push(new e(d.slice(u),Object.assign({},r.attributes)))}l=c}const r=this.mergePieces(o);this.blocks[c].pieces=r,this.emit("documentChanged",this)}toggleOrderedList(t){const e=this.blocks.findIndex((e=>e.dataId===t)),s=this.blocks.find((e=>e.dataId===t));s&&(s.listType="ol"===s.listType?null:"ol",s.listStart=1,this.blocks[e].listType=s.listType,console.log(s,"action -- block ol ",e,this.blocks[e].listType),this.emit("documentChanged",this))}toggleUnorderedList(t){const e=this.blocks.find((e=>e.dataId===t));e&&(e.listType="ul"===e.listType?null:"ul",this.emit("documentChanged",this))}toggleBoldRange(t,e){const s=this.isRangeEntirelyAttribute(t,e,"bold");this.formatAttribute(t,e,"bold",!s)}toggleItalicRange(t,e){const s=this.isRangeEntirelyAttribute(t,e,"italic");this.formatAttribute(t,e,"italic",!s)}toggleUnderlineRange(t,e){const s=this.isRangeEntirelyAttribute(t,e,"underline");this.formatAttribute(t,e,"underline",!s)}isRangeEntirelyAttribute(t,e,s){let i=this.currentOffset,n=!0;if(""!==this.selectedBlockId){const o=this.blocks.findIndex((t=>t.dataId===this.selectedBlockId));for(let l of this.blocks[o].pieces){const o=i+l.text.length;if(o>t&&i<e&&!l.attributes[s]){n=!1;break}i=o}}return n}mergePieces(t){let e=[];for(let s of t){const t=e[e.length-1];t&&t.hasSameAttributes(s)?t.text+=s.text:e.push(s)}return e}findPieceAtOffset(t,e=""){let s=this.currentOffset;if(""!==e){const i=this.blocks.findIndex((t=>t.dataId===e));for(let e of this.blocks[i].pieces){const i=s+e.text.length;if(t>=s&&t<=i)return e;s=i}}return null}}function i(t){const e=window.getSelection();if(!e||0===e.rangeCount)return null;const s=e.getRangeAt(0),i=s.cloneRange();i.selectNodeContents(t),i.setEnd(s.startContainer,s.startOffset);const n=i.toString().length;i.setEnd(s.endContainer,s.endOffset);return{start:n,end:i.toString().length}}class n{constructor(t,e){this.container=t,this.document=e}render(){const t=i(this.container);this.container.innerHTML="",console.log(this.document.blocks,"action -- block editorview"),this.document.blocks.forEach((t=>{if(""!==t.dataId){let e,s;"ol"===t.listType?(e=document.createElement("ol"),e.setAttribute("start",null==t?void 0:t.listStart.toString())):e="ul"===t.listType?document.createElement("ul"):document.createElement("div"),e.setAttribute("data-id",t.dataId),e.setAttribute("class",t.class),"ol"===t.listType||"ul"===t.listType?(s=document.createElement("li"),t.pieces.forEach((t=>{s.appendChild(this.renderPiece(t))})),e.append(s)):t.pieces.forEach((t=>{e.appendChild(this.renderPiece(t))})),this.container.appendChild(e)}})),function(t,e){if(!e)return;let s=0;const i=document.createRange();i.setStart(t,0),i.collapse(!0);const n=[t];let o,l=!1,c=!1;for(;!c&&(o=n.pop());)if(3===o.nodeType){const t=o,n=s+t.length;!l&&e.start>=s&&e.start<=n&&(i.setStart(t,e.start-s),l=!0),l&&e.end>=s&&e.end<=n&&(i.setEnd(t,e.end-s),c=!0),s=n}else if("BR"===o.tagName)l||e.start!==s||(i.setStartBefore(o),l=!0),l&&e.end===s&&(i.setEndBefore(o),c=!0),s++;else{const t=o;let e=t.childNodes.length;for(;e--;)n.push(t.childNodes[e])}const r=window.getSelection();r&&(r.removeAllRanges(),r.addRange(i))}(this.container,t)}renderPiece(t){const e=t.text.split("\n");return this.wrapAttributes(e,t.attributes)}wrapAttributes(t,e){const s=document.createDocumentFragment();return t.forEach(((i,n)=>{let o=document.createTextNode(i);if(e.underline){const t=document.createElement("u");t.appendChild(o),o=t}if(e.italic){const t=document.createElement("em");t.appendChild(o),o=t}if(e.bold){const t=document.createElement("strong");t.appendChild(o),o=t}s.appendChild(o),n<t.length-1&&s.appendChild(document.createElement("br"))})),s}}class o extends t{constructor(t){super(),this.container=t,this.setupButtons()}setupButtons(){this.container.querySelectorAll("button").forEach((t=>{t.addEventListener("mousedown",(t=>{t.preventDefault()}))})),this.container.addEventListener("click",(t=>{const e=t.target.closest("button");if(e){const t=e.getAttribute("data-action");t&&this.emit("toolbarAction",t)}}))}updateActiveStates(t){this.container.querySelectorAll("button").forEach((e=>{const s=e.getAttribute("data-action");let i=!1;"bold"===s&&t.bold&&(i=!0),"italic"===s&&t.italic&&(i=!0),"underline"===s&&t.underline&&(i=!0),e.classList.toggle("active",i)}))}}function l(t){return c((new DOMParser).parseFromString(t,"text/html").body,{bold:!1,italic:!1,underline:!1})}function c(t,s){let i=Object.assign({},s);const n=[];if(t instanceof HTMLElement)"STRONG"!==t.tagName&&"B"!==t.tagName||(i.bold=!0),"EM"!==t.tagName&&"I"!==t.tagName||(i.italic=!0),"U"===t.tagName&&(i.underline=!0),t.childNodes.forEach((t=>{console.log({child:t}),n.push(...c(t,i))}));else if(t instanceof Text){const s=t.nodeValue||"";""!==s.trim()&&n.push(new e(s,Object.assign({},i)))}return n}window.TextIgniter=class{constructor(t,i){this.document=new s,this.editorView=new n(t,this.document),this.toolbarView=new o(i),this.currentAttributes={bold:!1,italic:!1,underline:!1},this.manualOverride=!1,this.lastPiece=null,this.toolbarView.on("toolbarAction",(t=>this.handleToolbarAction(t))),this.document.on("documentChanged",(()=>this.editorView.render())),t.addEventListener("keydown",(t=>this.handleKeydown(t))),t.addEventListener("keyup",(()=>this.syncCurrentAttributesWithCursor())),document.addEventListener("keydown",(t=>{if((t.ctrlKey||t.metaKey)&&!t.altKey){const e=t.key.toLowerCase();if(["b","i","u"].includes(e)){t.preventDefault();const s="b"===e?"bold":"i"===e?"italic":"underline";this.handleToolbarAction(s)}}})),document.addEventListener("selectionchange",this.handleSelectionChange.bind(this)),this.document.emit("documentChanged",this.document),t.addEventListener("paste",(t=>{var s,i;t.preventDefault();const n=null===(s=t.clipboardData)||void 0===s?void 0:s.getData("text/html"),[o,c]=this.getSelectionRange();c>o&&this.document.deleteRange(o,c);let r=[];if(n)r=l(n);else{const s=(null===(i=t.clipboardData)||void 0===i?void 0:i.getData("text/plain"))||"";r=[new e(s,Object.assign({},this.currentAttributes))]}let d=o;for(const t of r)this.document.insertAt(t.text,Object.assign({},t.attributes),d,this.document.selectedBlockId),d+=t.text.length;this.setCursorPosition(d)})),t.addEventListener("dragover",(t=>{t.preventDefault()})),t.addEventListener("drop",(t=>{var s,i;t.preventDefault();const n=null===(s=t.dataTransfer)||void 0===s?void 0:s.getData("text/html"),[o,c]=this.getSelectionRange();c>o&&this.document.deleteRange(o,c);let r=[];if(n)r=l(n);else{const s=(null===(i=t.dataTransfer)||void 0===i?void 0:i.getData("text/plain"))||"";r=[new e(s,Object.assign({},this.currentAttributes))]}let d=o;for(const t of r)this.document.insertAt(t.text,Object.assign({},t.attributes),d,this.document.selectedBlockId),d+=t.text.length;this.setCursorPosition(d)}))}getSelectionRange(){const t=i(this.editorView.container);return t?[t.start,t.end]:[0,0]}handleToolbarAction(t){const[e,s]=this.getSelectionRange();switch(console.log(t,"action---"),t){case"orderedList":this.document.toggleOrderedList(this.document.selectedBlockId);break;case"unorderedList":this.document.toggleUnorderedList(this.document.selectedBlockId)}if(e<s)switch(t){case"bold":this.document.toggleBoldRange(e,s);break;case"italic":this.document.toggleItalicRange(e,s);break;case"underline":this.document.toggleUnderlineRange(e,s)}else this.currentAttributes[t]=!this.currentAttributes[t],this.manualOverride=!0;this.toolbarView.updateActiveStates(this.currentAttributes)}handleSelectionChange(){var t;const e=window.getSelection();if(!e||0===e.rangeCount)return;const s=null===(t=e.getRangeAt(0).startContainer.parentElement)||void 0===t?void 0:t.closest("[data-id]");s&&s instanceof HTMLElement&&(this.document.selectedBlockId=s.getAttribute("data-id")||null)}handleKeydown(t){var s,i,n,o;const[l,c]=this.getSelectionRange();if("Enter"===t.key){console.log("blocks",this.document.blocks),t.preventDefault();const r=`data-id-${Date.now()}`;if("ol"===(null===(s=this.document.blocks[this.document.blocks.length-1])||void 0===s?void 0:s.listType)||"ul"===(null===(i=this.document.blocks[this.document.blocks.length-1])||void 0===i?void 0:i.listType)){const t=null===(n=this.document.blocks[this.document.blocks.length-1])||void 0===n?void 0:n.listType;let s=1;"ol"===t&&(s=null===(o=this.document.blocks[this.document.blocks.length-1])||void 0===o?void 0:o.listStart,s+=1),this.document.blocks.push({dataId:r,class:"paragraph-block",pieces:[new e(" ")],listType:t,listStart:"ol"===t?s:""})}else this.document.blocks.push({dataId:r,class:"paragraph-block",pieces:[new e(" ")]});this.syncCurrentAttributesWithCursor(),this.editorView.render(),this.setCursorPosition(c+1,r),c>l&&this.document.deleteRange(l,c,this.document.selectedBlockId,this.document.currentOffset)}else"Backspace"===t.key?(t.preventDefault(),l===c&&l>0?(this.document.deleteRange(l-1,l,this.document.selectedBlockId,this.document.currentOffset),this.setCursorPosition(l-1)):c>l&&(this.document.deleteRange(l,c,this.document.selectedBlockId,this.document.currentOffset),this.setCursorPosition(l))):1!==t.key.length||t.ctrlKey||t.metaKey||t.altKey?"Delete"===t.key&&(t.preventDefault(),l===c?(this.document.deleteRange(l,l+1,this.document.selectedBlockId),this.setCursorPosition(l)):c>l&&(this.document.deleteRange(l,c,this.document.selectedBlockId),this.setCursorPosition(l))):(t.preventDefault(),c>l&&this.document.deleteRange(l,c,this.document.selectedBlockId,this.document.currentOffset),this.document.insertAt(t.key,Object.assign({},this.currentAttributes),l,this.document.selectedBlockId,this.document.currentOffset),this.setCursorPosition(l+1))}syncCurrentAttributesWithCursor(){const[t,e]=this.getSelectionRange();if(t===e){const e=this.document.findPieceAtOffset(t,this.document.selectedBlockId);e?(e!==this.lastPiece&&(this.manualOverride=!1,this.lastPiece=e),this.manualOverride||(this.currentAttributes={bold:e.attributes.bold,italic:e.attributes.italic,underline:e.attributes.underline},this.toolbarView.updateActiveStates(this.currentAttributes))):(this.manualOverride||(this.currentAttributes={bold:!1,italic:!1,underline:!1},this.toolbarView.updateActiveStates(this.currentAttributes)),this.lastPiece=null)}}setCursorPosition(t,e=""){if(""===e)this.editorView.container.focus();else{document.querySelector('[data-id="'+e+'"]').focus()}const s=window.getSelection();if(!s)return;const i=document.createRange();let n=0;const o=[this.editorView.container];let l;for(;l=o.pop();)if(3===l.nodeType){const e=l,s=n+e.length;if(t>=n&&t<=s){i.setStart(e,t-n),i.collapse(!0);break}n=s}else if("BR"===l.tagName){if(t===n){i.setStartBefore(l),i.collapse(!0);break}n++}else{const t=l;let e=t.childNodes.length;for(;e--;)o.push(t.childNodes[e])}s.removeAllRanges(),s.addRange(i)}};
