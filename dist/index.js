"use strict";class t{constructor(){this.events={}}on(t,e){this.events[t]||(this.events[t]=[]),this.events[t].push(e)}emit(t,e){this.events[t]&&this.events[t].forEach((t=>t(e)))}}class e{constructor(t,e={}){this.text=t,this.attributes={bold:e.bold||!1,italic:e.italic||!1,underline:e.underline||!1}}isBold(){return this.attributes.bold}setBold(t){this.attributes.bold=t}isItalic(){return this.attributes.italic}setItalic(t){this.attributes.italic=t}isUnderline(){return this.attributes.underline}setUnderline(t){this.attributes.underline=t}clone(){return new e(this.text,Object.assign({},this.attributes))}hasSameAttributes(t){return this.attributes.bold===t.attributes.bold&&this.attributes.italic===t.attributes.italic&&this.attributes.underline===t.attributes.underline}}class i extends t{constructor(){super(),this.pieces=[new e("")]}getPlainText(){return this.pieces.map((t=>t.text)).join("")}insertAt(t,i,n){let s=0,r=[],o=!1;for(let c of this.pieces){const a=s+c.text.length;if(!o&&n<=a){const a=n-s;a>0&&r.push(new e(c.text.slice(0,a),Object.assign({},c.attributes))),r.push(new e(t,{bold:i.bold||!1,italic:i.italic||!1,underline:i.underline||!1})),a<c.text.length&&r.push(new e(c.text.slice(a),Object.assign({},c.attributes))),o=!0}else r.push(c.clone());s=a}if(!o){const n=r[r.length-1];n&&n.hasSameAttributes(new e("",{bold:i.bold||!1,italic:i.italic||!1,underline:i.underline||!1}))?n.text+=t:r.push(new e(t,{bold:i.bold||!1,italic:i.italic||!1,underline:i.underline||!1}))}this.pieces=this.mergePieces(r),this.emit("documentChanged",this)}deleteRange(t,i){if(t===i)return;let n=[],s=0;for(let r of this.pieces){const o=s+r.text.length;if(o<=t||s>=i)n.push(r.clone());else{const c=s,a=r.text;t>c&&t<o&&n.push(new e(a.slice(0,t-c),Object.assign({},r.attributes))),i<o&&n.push(new e(a.slice(i-c),Object.assign({},r.attributes)))}s=o}this.pieces=this.mergePieces(n),this.emit("documentChanged",this)}formatAttribute(t,i,n,s){let r=[],o=0;for(let c of this.pieces){const a=o+c.text.length;if(a<=t||o>=i)r.push(c.clone());else{const a=o,l=c.text,u=Math.max(t-a,0),d=Math.min(i-a,l.length);u>0&&r.push(new e(l.slice(0,u),Object.assign({},c.attributes)));const h=new e(l.slice(u,d),Object.assign({},c.attributes));h.attributes[n]=s,r.push(h),d<l.length&&r.push(new e(l.slice(d),Object.assign({},c.attributes)))}o=a}this.pieces=this.mergePieces(r),this.emit("documentChanged",this)}toggleBoldRange(t,e){const i=this.isRangeEntirelyAttribute(t,e,"bold");this.formatAttribute(t,e,"bold",!i)}toggleItalicRange(t,e){const i=this.isRangeEntirelyAttribute(t,e,"italic");this.formatAttribute(t,e,"italic",!i)}toggleUnderlineRange(t,e){const i=this.isRangeEntirelyAttribute(t,e,"underline");this.formatAttribute(t,e,"underline",!i)}isRangeEntirelyAttribute(t,e,i){let n=0,s=!0;for(let r of this.pieces){const o=n+r.text.length;if(o>t&&n<e&&!r.attributes[i]){s=!1;break}n=o}return s}mergePieces(t){let e=[];for(let i of t){const t=e[e.length-1];t&&t.hasSameAttributes(i)?t.text+=i.text:e.push(i)}return e}findPieceAtOffset(t){let e=0;for(let i of this.pieces){const n=e+i.text.length;if(t>=e&&t<=n)return i;e=n}return null}}function n(t){const e=window.getSelection();if(!e||0===e.rangeCount)return null;const i=e.getRangeAt(0),n=i.cloneRange();n.selectNodeContents(t),n.setEnd(i.startContainer,i.startOffset);const s=n.toString().length;n.setEnd(i.endContainer,i.endOffset);return{start:s,end:n.toString().length}}class s{constructor(t,e){this.container=t,this.document=e}render(){const t=n(this.container);this.container.innerHTML="",this.document.pieces.forEach((t=>{this.container.appendChild(this.renderPiece(t))})),function(t,e){if(!e)return;let i=0;const n=document.createRange();n.setStart(t,0),n.collapse(!0);const s=[t];let r,o=!1,c=!1;for(;!c&&(r=s.pop());)if(3===r.nodeType){const t=r,s=i+t.length;!o&&e.start>=i&&e.start<=s&&(n.setStart(t,e.start-i),o=!0),o&&e.end>=i&&e.end<=s&&(n.setEnd(t,e.end-i),c=!0),i=s}else if("BR"===r.tagName)o||e.start!==i||(n.setStartBefore(r),o=!0),o&&e.end===i&&(n.setEndBefore(r),c=!0),i++;else{const t=r;let e=t.childNodes.length;for(;e--;)s.push(t.childNodes[e])}const a=window.getSelection();a&&(a.removeAllRanges(),a.addRange(n))}(this.container,t)}renderPiece(t){const e=t.text.split("\n");return this.wrapAttributes(e,t.attributes)}wrapAttributes(t,e){const i=document.createDocumentFragment();return t.forEach(((n,s)=>{let r=document.createTextNode(n);if(e.underline){const t=document.createElement("u");t.appendChild(r),r=t}if(e.italic){const t=document.createElement("em");t.appendChild(r),r=t}if(e.bold){const t=document.createElement("strong");t.appendChild(r),r=t}i.appendChild(r),s<t.length-1&&i.appendChild(document.createElement("br"))})),i}}class r extends t{constructor(t){super(),this.container=t,this.setupButtons()}setupButtons(){this.container.querySelectorAll("button").forEach((t=>{t.addEventListener("mousedown",(t=>{t.preventDefault()}))})),this.container.addEventListener("click",(t=>{const e=t.target.closest("button");if(e){const t=e.getAttribute("data-action");t&&this.emit("toolbarAction",t)}}))}updateActiveStates(t){this.container.querySelectorAll("button").forEach((e=>{const i=e.getAttribute("data-action");let n=!1;"bold"===i&&t.bold&&(n=!0),"italic"===i&&t.italic&&(n=!0),"underline"===i&&t.underline&&(n=!0),e.classList.toggle("active",n)}))}}window.TextIgniter=class{constructor(t,e){this.document=new i,this.editorView=new s(t,this.document),this.toolbarView=new r(e),this.currentAttributes={bold:!1,italic:!1,underline:!1},this.manualOverride=!1,this.lastPiece=null,this.toolbarView.on("toolbarAction",(t=>this.handleToolbarAction(t))),this.document.on("documentChanged",(()=>this.editorView.render())),t.addEventListener("keydown",(t=>this.handleKeydown(t))),t.addEventListener("keyup",(()=>this.syncCurrentAttributesWithCursor())),document.addEventListener("keydown",(t=>{if((t.ctrlKey||t.metaKey)&&!t.altKey){const e=t.key.toLowerCase();if(["b","i","u"].includes(e)){t.preventDefault();const i="b"===e?"bold":"i"===e?"italic":"underline";this.handleToolbarAction(i)}}})),this.document.emit("documentChanged",this.document)}getSelectionRange(){const t=n(this.editorView.container);return t?[t.start,t.end]:[0,0]}handleToolbarAction(t){const[e,i]=this.getSelectionRange();if(e<i)switch(t){case"bold":this.document.toggleBoldRange(e,i);break;case"italic":this.document.toggleItalicRange(e,i);break;case"underline":this.document.toggleUnderlineRange(e,i)}else this.currentAttributes[t]=!this.currentAttributes[t],this.manualOverride=!0;this.toolbarView.updateActiveStates(this.currentAttributes)}handleKeydown(t){const[e,i]=this.getSelectionRange();"Enter"===t.key?(t.preventDefault(),i>e&&this.document.deleteRange(e,i),this.document.insertAt("\n",Object.assign({},this.currentAttributes),e),this.setCursorPosition(e+1)):"Backspace"===t.key?(t.preventDefault(),e===i&&e>0?(this.document.deleteRange(e-1,e),this.setCursorPosition(e-1)):i>e&&(this.document.deleteRange(e,i),this.setCursorPosition(e))):1!==t.key.length||t.ctrlKey||t.metaKey||t.altKey||(t.preventDefault(),i>e&&this.document.deleteRange(e,i),this.document.insertAt(t.key,Object.assign({},this.currentAttributes),e),this.setCursorPosition(e+1))}syncCurrentAttributesWithCursor(){const[t,e]=this.getSelectionRange();if(t===e){const e=this.document.findPieceAtOffset(t);e?(e!==this.lastPiece&&(this.manualOverride=!1,this.lastPiece=e),this.manualOverride||(this.currentAttributes={bold:e.attributes.bold,italic:e.attributes.italic,underline:e.attributes.underline},this.toolbarView.updateActiveStates(this.currentAttributes))):(this.manualOverride||(this.currentAttributes={bold:!1,italic:!1,underline:!1},this.toolbarView.updateActiveStates(this.currentAttributes)),this.lastPiece=null)}}setCursorPosition(t){this.editorView.container.focus();const e=window.getSelection();if(!e)return;const i=document.createRange();let n=0;const s=[this.editorView.container];let r;for(;r=s.pop();)if(3===r.nodeType){const e=r,s=n+e.length;if(t>=n&&t<=s){i.setStart(e,t-n),i.collapse(!0);break}n=s}else if("BR"===r.tagName){if(t===n){i.setStartBefore(r),i.collapse(!0);break}n++}else{const t=r;let e=t.childNodes.length;for(;e--;)s.push(t.childNodes[e])}e.removeAllRanges(),e.addRange(i)}};
